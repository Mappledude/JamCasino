<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JamCasino — Poker Table</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #101935;
      --ink: #e7ecff;
      --muted: #9aa3c7;
      --accent: #7c5cff;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --chip: #1f2a50;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
    }
    header {
      padding: 12px 16px; background: linear-gradient(180deg, #0e1430, #0b1020);
      border-bottom: 1px solid #1a2247; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    }
    header h1 { font-size: 16px; margin: 0; opacity: .9; font-weight: 600; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #121b3b; border: 1px solid #1d2856; color: var(--muted); font-size: 12px; }
    main { display: grid; grid-template-columns: 360px 1fr 420px; gap: 16px; padding: 16px; }
    @media (max-width: 1100px) {
      main { grid-template-columns: 1fr; }
      .col { order: unset !important; }
    }
    .panel {
      background: var(--card); border: 1px solid #1a2247; border-radius: 16px; padding: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    h2 { font-size: 14px; margin: 0 0 10px 0; color: var(--muted); font-weight: 600; letter-spacing:.2px; }
    button, input, select {
      background: #0f1736; color: var(--ink); border: 1px solid #29336b;
      padding: 10px 12px; border-radius: 12px; font-size: 14px;
    }
    button { cursor: pointer; }
    button.primary { background: var(--accent); border-color: #5a3dff; }
    button.ghost { background: transparent; border-color: #2a356e; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .stack { display: grid; gap: 8px; }
    .list { display: grid; gap: 8px; max-height: 280px; overflow: auto; }
    .roomItem { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #0e1632; border: 1px solid #222c62; border-radius: 12px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    /* Debug panel */
    #debugLog {
      background: #060a1c; min-height: 160px; max-height: 320px; overflow: auto; border-radius: 12px;
      border: 1px solid #18204a; padding: 10px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; line-height: 1.35;
      white-space: pre-wrap;
    }
    .kbd {
      background: #0a1230; border: 1px solid #1a255a; border-bottom-width: 3px; padding: 2px 6px; border-radius: 6px; font-size: 12px;
    }
    .dealbar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #0e1330; border: 1px dashed #2c376e; border-radius: 12px; }

    /* ---- Table / seats ---- */
    #felt {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: radial-gradient(circle at center, #0e6a3b, #0a5130);
      border-radius: 20px;
      overflow: hidden;
    }
    #tableBox {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 70%; height: 60%;
      background: #166c42;
      border-radius: 50% / 55%;
      box-shadow: inset 0 0 40px rgba(0,0,0,.6);
    }
    #community-board {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      display: flex; gap: 8px;
    }
    .seat {
      position: absolute; width: 100px; text-align: center;
      transform: translate(-50%, -50%);
    }
    .seat .cards { display: flex; justify-content: center; gap: 4px; margin-top: 4px; }
    .seat .card {
      width: 40px; height: 60px; border-radius: 4px; background: #fff;
      display: flex; align-items: center; justify-content: center; color: #000;
      font-size: 18px; font-weight: 600;
    }
    .seat .card.empty { background: transparent; border:1px dashed #1a2247; color:transparent; }
    .seat .card.back { background:#fff; }
    .seat.me { width: 180px; }
    .seat.me .card { width: 60px; height: 90px; }
    .action-bar { margin-top: 8px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .avatar {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--muted); color: #000;
      display:flex; align-items:center; justify-content:center;
      margin: 0 auto 4px;
      font-weight:600;
    }
    .badge { font-size: 10px; padding: 2px 4px; border-radius: 4px; background: var(--card); border:1px solid #1a2247; }
    .folded { opacity: .4; }
    @media (max-width: 1280px) {
      .seat { width: 80px; }
      .seat .card { width: 32px; height: 48px; font-size: 14px; }
      .seat.me { width: 150px; }
      .seat.me .card { width: 48px; height: 72px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>JamCasino — Player</h1>
    <span class="pill" id="uidPill">uid: …</span>
    <span class="pill" id="roomPill">room: (none)</span>
  </header>

  <main>
    <!-- Lobby (left) -->
    <section class="panel col" style="order:1">
      <h2>Lobby</h2>
      <div class="stack">
        <div class="row">
          <input id="nameInput" placeholder="Your name" style="flex:1" />
        </div>
        <div class="row">
          <input id="codeInput" class="mono" placeholder="Room code (e.g., ABC123)" style="flex:1" />
          <button id="enterBtn" class="primary">Enter Room</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <h2>Open Rooms</h2>
      <div id="roomsList" class="list"></div>
    </section>

    <!-- Table / Actions (center) -->
    <section class="panel col" style="order:2">
      <h2>Table</h2>
      <div class="dealbar">
        <div>
          <div class="row" style="gap:6px">
            <span class="kbd">phase:</span><span id="phaseLbl">idle</span>
            <span class="kbd">street:</span><span id="streetLbl">idle</span>
            <span class="kbd">pot¢:</span><span id="potLbl">0</span>
          </div>
          <div class="row" style="gap:6px; margin-top:6px">
            <span class="kbd">Active players:</span><span id="activeCountLbl">0</span>
          </div>
        </div>
        <div class="row">
          <button id="dealBtn" class="primary" disabled>Deal</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div id="felt" hidden><div id="tableBox"></div></div>
      <div id="playersBox"></div>
    </section>

    <!-- Debug (right) -->
    <section class="panel col" style="order:3">
      <h2>Debug</h2>
      <div class="row">
        <button id="clearLogBtn" class="ghost">Clear</button>
      </div>
      <div id="debugLog">[info] Debug panel ready.</div>
    </section>
  </main>

  <!-- Firebase v10 (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserSessionPersistence,
      onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, serverTimestamp, collection, doc, getDocs, onSnapshot,
      setDoc, updateDoc, deleteDoc, query, orderBy, limit, where,
      runTransaction, deleteField
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { fullDeck, shuffle } from "./lib/deck.js";

    // --------- Config (use EXACTLY as provided) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDW9Subu-SEcSoe-uHNT8FzazZhgRknOHg",
      authDomain: "jamcasino-36b9a.firebaseapp.com",
      projectId: "jamcasino-36b9a",
      storageBucket: "jamcasino-36b9a.firebasestorage.app",
      messagingSenderId: "173219554638",
      appId: "1:173219554638:web:597524a6a30e71f3a2aa1f"
    };

    // --------- App init ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- Tiny logger ----------
    const $log = document.getElementById('debugLog');
    const log = (tag, payload) => {
      const time = new Date().toISOString();
      $log.textContent += `\n[${time}] ${tag}: ${payload ? JSON.stringify(payload) : ""}`;
      $log.scrollTop = $log.scrollHeight;
    };
    log("info", "Auth starting…");

    // ---------- UI refs ----------
    const $uid = document.getElementById('uidPill');
    const $roomPill = document.getElementById('roomPill');
    const $roomsList = document.getElementById('roomsList');
    const $name = document.getElementById('nameInput');
    const $code = document.getElementById('codeInput');
    const $enter = document.getElementById('enterBtn');
    const $deal = document.getElementById('dealBtn');
    const $phase = document.getElementById('phaseLbl');
    const $street = document.getElementById('streetLbl');
    const $pot = document.getElementById('potLbl');
    const $activeCountLbl = document.getElementById('activeCountLbl');
    const $playersBox = document.getElementById('playersBox');
    document.getElementById('clearLogBtn').onclick = () => { $log.textContent = "[info] Debug panel ready."; };

    // ---------- State ----------
    let me = null;          // my auth user
    let roomCode = null;    // joined room code
    let unsubRoom = null;   // room listener
    let unsubPlayers = null;// players listener
    let lastRoomState = null;
    let lastPlayers = [];

    // ---------- Helpers ----------
    const dollars = (cents) => (cents / 100).toFixed(2);
    const inCents = (d) => Math.round(Number(d) * 100);
    const sanitize = (obj) => {
      // Remove undefined values (flat only)
      const out = {};
      Object.keys(obj || {}).forEach(k => {
        if (obj[k] !== undefined) out[k] = obj[k];
      });
      return out;
    };
    const cardText = (c) => {
      if (!c) return "";
      if (typeof c === "string") return c;
      return `${c.rank || ""}${c.suit || ""}`;
    };

    // ---------- Auth with per-tab session ----------
    await setPersistence(auth, browserSessionPersistence);
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await signInAnonymously(auth);
        return;
      }
      me = user;
      $uid.textContent = "uid: " + me.uid;
      log("auth.ready", { uid: me.uid });
    });

    // ---------- Lobby: list rooms (active !== false) ----------
    const roomsCol = collection(db, "rooms");
    onSnapshot(roomsCol, (snap) => {
      $roomsList.innerHTML = "";
      let count = 0;
      snap.forEach(docSnap => {
        const r = docSnap.data() || {};
        if (r.active === false) return; // lobby shows only active rooms
        count++;
        const div = document.createElement('div');
        div.className = "roomItem";
        div.innerHTML = `
          <div>
            <div class="mono" style="font-weight:600">${r.code || docSnap.id}</div>
            <div style="font-size:12px;color:var(--muted)">
              $${dollars((r.blinds?.sbC||25))}/$${dollars((r.blinds?.bbC||50))}
              — Buy-in: $${dollars((r.limits?.minBuyInC||1000))}–$${dollars((r.limits?.maxBuyInC||10000))}
            </div>
          </div>
          <button data-code="${docSnap.id}">Enter</button>`;
        div.querySelector('button').onclick = () => enterRoom(docSnap.id);
        $roomsList.appendChild(div);
      });
      log("lobby.rooms", { count });
    });

    // ---------- Enter room (join as player subdoc) ----------
    async function enterRoom(code) {
      try {
        const name = ($name.value || "").trim() || "Player";
        const buyInD = 10; // $10 starter (display only, stack stored as dollars per spec)
        log("lobby.join.click", { code, name });
        const playersRef = collection(db, "rooms", code, "players");
        const snap = await getDocs(playersRef);
        const active = snap.docs.filter(d => !(d.data().leftAt) && !(d.data().eliminated)).length;
        if (active >= 9) { alert("Room full"); return; }
        const playerDoc = doc(playersRef, auth.currentUser.uid);
        await setDoc(playerDoc, sanitize({
          id: auth.currentUser.uid,
          name,
          stack: buyInD,          // dollars (float) on player record
          hole: [],               // dealt later
          joinedAt: serverTimestamp(),
          leftAt: null,
          folded: false,
          eliminated: false,
          allIn: false
        }), { merge: true });
        log("lobby.join.success", { code, buyIn: buyInD, name });
        roomCode = code;
        $roomPill.textContent = "room: " + roomCode;
        startRoomListeners();
      } catch (err) {
        log("error.join", { message: err.message });
        alert("Join failed: " + err.message);
      }
    }
    document.getElementById('enterBtn').onclick = () => {
      const codeVal = ($code.value || "").trim();
      if (codeVal) enterRoom(codeVal);
    };

    // ---------- Room + Players listeners ----------
    function startRoomListeners() {
      if (!roomCode) return;
      // Room doc
      const roomRef = doc(db, "rooms", roomCode);
      if (unsubRoom) unsubRoom();
      unsubRoom = onSnapshot(roomRef, (snap) => {
        if (!snap.exists()) return;
        const r = snap.data();
        lastRoomState = r;
        $phase.textContent = r.phase || "idle";
        $street.textContent = r.street || "idle";
        $pot.textContent = String(r.potC || 0);
        renderTable(lastPlayers, me?.uid);
        log("room.snapshot", { phase: r.phase || "idle", street: r.street || "idle", potC: r.potC || 0 });
        decideDealVisibility(r);
      });

      // Players
      const playersRef = collection(db, "rooms", roomCode, "players");
      if (unsubPlayers) unsubPlayers();
      unsubPlayers = onSnapshot(playersRef, (snap) => {
        const players = [];
        snap.forEach(d => players.push(d.data()));
        players.sort((a,b) => (a.name||"").localeCompare(b.name||""));
        lastPlayers = players;
        const active = players.filter(p => !p.leftAt && !p.eliminated).length;
        $activeCountLbl.textContent = String(active);
        renderPlayers(players);
        renderTable(players, me?.uid);
        log("players.snapshot", { n: players.length, activeCount: active, players: players.map(p => ({ id:p.id, name:p.name, stack:p.stack, leftAt: !!p.leftAt, eliminated: !!p.eliminated })) });
      });
    }

    function renderPlayers(players) {
      $playersBox.innerHTML = "";
      if (!players.length) {
        $playersBox.innerHTML = '<div style="color:var(--muted)">No players yet.</div>';
        return;
      }
      for (const p of players) {
        const row = document.createElement('div');
        row.className = "row";
        row.style.justifyContent = "space-between";
        row.style.padding = "8px 10px";
        row.style.border = "1px solid #1a2247";
        row.style.borderRadius = "10px";
        row.style.background = "#0c1430";
        row.innerHTML = `
          <div><strong>${p.name || "Player"}</strong> <span class="mono" style="color:var(--muted)">(${p.id?.slice(0,6)})</span></div>
          <div class="mono">$${(p.stack ?? 0).toFixed(2)}</div>
        `;
        $playersBox.appendChild(row);
      }
    }

    // ---- Table rendering ----
    
function renderTable(players, meId) {
  const room = lastRoomState || {};
  const $felt = document.getElementById('felt');
  const $table = document.getElementById('tableBox');
  if (!players || !players.length) { $felt.hidden = true; return; }
  $felt.hidden = false;

  const ordered = [];
  let mePlayer = null;
  players.forEach(p => { if (p.id === meId) mePlayer = p; else ordered.push(p); });
  if (mePlayer) ordered.unshift(mePlayer);
  const n = Math.min(ordered.length, 9);

  const angleStep = 360 / n;
  const seatsHtml = [];
  const layout = [];

  for (let i=0;i<n;i++) {
    const p = ordered[i];
    const angDeg = angleStep * i;
    const ang = angDeg * Math.PI / 180;
    const left = 50 + Math.sin(ang) * 40;
    const top = 50 - Math.cos(ang) * 40;
    const dim = (p.folded || p.eliminated) ? 'folded' : '';
    let cardsHtml = '<div class="card empty"></div><div class="card empty"></div>';
    const showCards = room.phase !== 'idle' && room.street !== 'idle';
    const hole = showCards ? (p.hole || []) : [];
    if (hole.length === 2) {
      cardsHtml = (p.id === meId)
        ? hole.map(c=>`<div class="card">${cardText(c)}</div>`).join('')
        : '<div class="card back">🂠</div><div class="card back">🂠</div>';
    }
    const badges = [];
    if (room?.dealerId === p.id) badges.push('D');
    if (room?.committed && room.committed[p.id]) {
      const amt = room.committed[p.id];
      if (amt === (room?.blinds?.sbC || 25)) badges.push('SB');
      if (amt === (room?.blinds?.bbC || 50)) badges.push('BB');
    }
    if (p.id === meId) {
      seatsHtml.push(`<div class="seat me ${dim}" style="left:${left}%;top:${top}%">`+
        `<div class="avatar">${(p.name||'')[0]||'?'}</div>`+
        `<div>${p.name||'Player'} — $${(p.stack||0).toFixed(2)}</div>`+
        `<div class="cards">${cardsHtml}</div>`+
        `<div class="action-bar"><button id="foldBtn">Fold</button><button id="checkBtn">Check/Call</button><button id="betBtn">Bet/Raise</button><input id="betAmt" type="number" style="display:none;width:80px"/><input id="betSlider" type="range" style="display:none;width:80px"/></div>`+
      `</div>`);
    } else {
      seatsHtml.push(`<div class="seat ${dim}" style="left:${left}%;top:${top}%">`+
        `<div class="avatar">${(p.name||'')[0]||'?'}</div>`+
        `<div>${p.name||'Player'}</div>`+
        `<div class="cards">${cardsHtml}</div>`+
        `<div>${badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>`+
      `</div>`);
    }
    layout.push({ name: p.name || 'Player', uid: p.id, seatAngle: angDeg });
  }

  const board = room.board || { flop:[], turn:null, river:null };
  const show = room.showBoard || { flop:false, turn:false, river:false };
  const boardHtmlArr = [];
  const boardCards = [...(board.flop||[]), ...(board.turn ? [board.turn] : []), ...(board.river ? [board.river] : [])];
  for (let i=0;i<5;i++) {
    const c = boardCards[i];
    if (!c || room.phase === 'idle' || room.street === 'idle') {
      boardHtmlArr.push('<div class="card empty"></div>');
    } else {
      if (i<3 && !show.flop) boardHtmlArr.push('<div class="card back">🂠</div>');
      else if (i===3 && !show.turn) boardHtmlArr.push('<div class="card back">🂠</div>');
      else if (i===4 && !show.river) boardHtmlArr.push('<div class="card back">🂠</div>');
      else boardHtmlArr.push(`<div class="card">${cardText(c)}</div>`);
    }
  }

  $table.innerHTML = `<div id="community-board">${boardHtmlArr.join('')}</div>` + seatsHtml.join('');
  setupActionBar(mePlayer, room);
  log("ui.layout.ready", { seatCount: layout.length, meSeatIndex: mePlayer?0:-1, seats: layout });
}

function setupActionBar(mePlayer, room) {
  const $fold = document.getElementById('foldBtn');
  const $check = document.getElementById('checkBtn');
  const $bet = document.getElementById('betBtn');
  const $amt = document.getElementById('betAmt');
  const $slider = document.getElementById('betSlider');
  if (!$fold || !$check || !$bet) return;
  const acting = room?.acting;
  const enabled = acting === me?.uid;
  [$fold,$check,$bet,$amt,$slider].forEach(el=>{ if(el) el.disabled = !enabled; });
  $amt.style.display = $slider.style.display = 'none';
  const bb = (room?.blinds?.bbC || 50)/100;
  const max = mePlayer?.stack || 0;
  $bet.onclick = () => {
    log('ui.action.click',{action:'bet-raise'});
    if(enabled){
      $amt.min = bb; $amt.max = max; $amt.value = bb;
      $slider.min = bb; $slider.max = max; $slider.value = bb;
      $amt.style.display = $slider.style.display = 'block';
    }
  };
  $fold.onclick = () => log('ui.action.click',{action:'fold'});
  $check.onclick = () => { log('ui.action.click',{action:'check-call'}); $amt.style.display=$slider.style.display='none'; };
  log('ui.actionbar.state',{enabled, acting});
}
// ---------- Deal button visibility rules (Step 0 scope) ----------
    async function decideDealVisibility(roomData) {
      const playersSnap = await getDocs(collection(db, "rooms", roomCode, "players"));
      const players = [];
      playersSnap.forEach(d => players.push({ id: d.id, ...d.data() }));

      const activePlayers = players.filter(p => !p.leftAt && !p.eliminated);
      const active = activePlayers.length;
      let earliest = null, earliestTs = 1e18;
      activePlayers.forEach(p => {
        const ts = p.joinedAt?.seconds ?? p.joinedAt?._seconds ?? null;
        const millis = ts ? ts * 1000 : null;
        if (millis !== null && millis < earliestTs) { earliestTs = millis; earliest = p.id; }
      });

      const isIdle = (roomData?.phase || "idle") === "idle";
      const canShow = isIdle && active >= 2 && earliest === auth.currentUser.uid;
      $deal.disabled = !canShow;
      $deal.style.opacity = canShow ? "1" : ".6";
      log("ui.deal.visibility", {
        showDeal: canShow, phase: roomData?.phase || "idle", activeCount: active,
        earliest, me: auth.currentUser.uid, reason: canShow ? "ok" : (active<2 ? "<2 players" : (isIdle? "not-earliest" : "phase!=idle"))
      });
    }

    async function startHand(code, dealerUid) {
      let composed = false;
      const roomRef = doc(db, "rooms", code);
      try {
        const result = await runTransaction(db, async (tx) => {
          const roomSnap = await tx.get(roomRef);
          const r = roomSnap.data() || {};
          if (r.phase !== "idle" || r.street !== "idle") throw new Error("not-idle");
          const lockAt = r.lock?.at?.toMillis ? r.lock.at.toMillis() : 0;
          if (r.lock?.name === 'deal' && Date.now() - lockAt < 10000) throw new Error('locked');
          const playersSnap = await tx.get(query(collection(db, 'rooms', code, 'players')));
          const players = [];
          playersSnap.forEach(d => players.push({ id: d.id, ...d.data() }));
          const active = players.filter(p => !p.leftAt && !p.eliminated);
          if (active.length < 2) throw new Error('<2 players');
          active.sort((a,b)=>{ const ta=a.joinedAt?.seconds??0, tb=b.joinedAt?.seconds??0; return ta-tb; });
          const earliest = active[0]?.id;
          if (dealerUid !== earliest) throw new Error('not-dealer');
          const seatOrder = active.map(p=>p.id);
          const n = seatOrder.length;
          const dealerIdx = seatOrder.indexOf(earliest);
          let sbIdx, bbIdx;
          if (n === 2) {
            sbIdx = dealerIdx; bbIdx = (dealerIdx + 1) % n;
          } else {
            sbIdx = (dealerIdx + 1) % n; bbIdx = (sbIdx + 1) % n;
          }
          const sbPid = seatOrder[sbIdx];
          const bbPid = seatOrder[bbIdx];
          const order = [];
          if (n === 2) {
            order.push(sbPid, bbPid);
          } else {
            let idx = (bbIdx + 1) % n;
            while (order.length < n) { order.push(seatOrder[idx]); idx = (idx + 1) % n; }
          }
          const deck = shuffle(fullDeck());
          const sbC = r?.blinds?.sbC ?? 25;
          const bbC = r?.blinds?.bbC ?? 50;
          const committed = {};
          let potC = 0;
          for (const pid of seatOrder) {
            const pRef = doc(db, 'rooms', code, 'players', pid);
            const pSnap = await tx.get(pRef);
            const pdata = pSnap.data() || {};
            if (pdata.leftAt || pdata.eliminated) throw new Error('player-left');
            const card1 = deck.pop();
            const card2 = deck.pop();
            let stack = Number(pdata.stack || 0);
            let commit = 0;
            if (pid === sbPid) { commit = Math.min(stack, sbC); stack = Math.max(0, stack - sbC); }
            if (pid === bbPid) { commit = Math.min(stack, bbC); stack = Math.max(0, stack - bbC); }
            committed[pid] = commit;
            potC += commit;
            tx.update(pRef, {
              hole: [
                { rank: card1.rank, suit: card1.suit },
                { rank: card2.rank, suit: card2.suit }
              ],
              stack
            });
          }
          const handId = Date.now().toString(36);
          const lock = { name: 'deal', by: dealerUid, handId, at: serverTimestamp() };
          tx.update(roomRef, {
            phase: 'betting',
            street: 'preflop',
            handId,
            dealerId: dealerUid,
            sbPid,
            bbPid,
            order,
            acting: order[0],
            lastAggressor: bbPid,
            potC,
            committed,
            board: { flop: [], turn: null, river: null },
            lock,
            updatedAt: serverTimestamp(),
          });
          if (!composed) {
            log('hand.deal.compose', { dealerId: dealerUid, sbPid, bbPid, order, potC, committed });
            composed = true;
          }
          return { nPlayers: n };
        });
        log('hand.deal.success', { code, nPlayers: result.nPlayers });
      } catch (err) {
        log('hand.deal.blocked', { reason: err.message });
      }
    }

    // ---------- Deal click (delegates to startHand) ----------
    $deal.onclick = async () => {
      if (!roomCode) return;
      log('ui.deal.click', { room: roomCode });
      await startHand(roomCode, auth.currentUser.uid);
    };
  </script>
</body>
</html>
